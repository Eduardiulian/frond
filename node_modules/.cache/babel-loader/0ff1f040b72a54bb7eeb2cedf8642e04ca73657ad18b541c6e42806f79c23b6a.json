{"ast":null,"code":"const RENDER_DELAY = 100;\nconst gameUpdates = [];\nlet gameStart = 0;\nlet firstServerTimestamp = 0;\nexport function initState() {\n  gameStart = 0;\n  firstServerTimestamp = 0;\n}\nexport function processGameUpdate(update) {\n  if (!firstServerTimestamp) {\n    firstServerTimestamp = update.t;\n    gameStart = Date.now();\n  }\n  gameUpdates.push(update);\n  const base = getBaseUpdate();\n  if (base > 0) {\n    gameUpdates.splice(0, base);\n  }\n}\nfunction currentServerTime() {\n  return firstServerTimestamp + (Date.now() - gameStart) - RENDER_DELAY;\n}\nfunction getBaseUpdate() {\n  const serverTime = currentServerTime();\n  for (let i = gameUpdates.length - 1; i >= 0; i--) {\n    if (gameUpdates[i].t <= serverTime) {\n      return i;\n    }\n  }\n  return -1;\n}\nexport function getCurrentState() {\n  if (!firstServerTimestamp) {\n    return {};\n  }\n  const base = getBaseUpdate();\n  const serverTime = currentServerTime();\n  // If base is the most recent update we have, use its state.\n  // Otherwise, interpolate between its state and the state of (base + 1).\n  if (base < 0 || base === gameUpdates.length - 1) {\n    return gameUpdates[gameUpdates.length - 1];\n  } else {\n    const baseUpdate = gameUpdates[base];\n    const next = gameUpdates[base + 1];\n    const ratio = (serverTime - baseUpdate.t) / (next.t - baseUpdate.t);\n    return {\n      me: interpolateObject(baseUpdate.me, next.me, ratio),\n      others: baseUpdate.others,\n      lines: baseUpdate.lines,\n      remainders: baseUpdate.remainders,\n      usernames: baseUpdate.usernames\n    };\n  }\n}\nfunction interpolateObject(object1, object2, ratio) {\n  if (!object2) {\n    return object1;\n  }\n  const interpolated = {};\n  Object.keys(object1).forEach(key => {\n    if (key === 'coordinates') {\n      interpolated[key] = interpolateObjectArray(object1[key], object2[key], ratio);\n    } else if (key === 'x' || key === 'y') {\n      interpolated[key] = object1[key] + (object2[key] - object1[key]) * ratio;\n    } else if (key === 'color' || key === 'radius') {\n      interpolated[key] = object1[key];\n    } else {\n      interpolated[key] = interpolateObject(object1[key], object2[key], ratio);\n    }\n  });\n  return interpolated;\n}\nfunction interpolateObjectArray(objects1, objects2, ratio) {\n  let arr = [];\n  for (let i = 0; i < objects1.length; i++) {\n    arr.push(interpolateObject(objects1[i], objects2[i], ratio));\n  }\n  return arr;\n}","map":{"version":3,"names":["RENDER_DELAY","gameUpdates","gameStart","firstServerTimestamp","initState","processGameUpdate","update","t","Date","now","push","base","getBaseUpdate","splice","currentServerTime","serverTime","i","length","getCurrentState","baseUpdate","next","ratio","me","interpolateObject","others","lines","remainders","usernames","object1","object2","interpolated","Object","keys","forEach","key","interpolateObjectArray","objects1","objects2","arr"],"sources":["/home/edi/secario.fun/frondend/src/services/state.js"],"sourcesContent":["const RENDER_DELAY = 100;\n\nconst gameUpdates = [];\nlet gameStart = 0;\nlet firstServerTimestamp = 0;\n\nexport function initState() {\n  gameStart = 0;\n  firstServerTimestamp = 0;\n}\n\nexport function processGameUpdate(update) {\n  if (!firstServerTimestamp) {\n    firstServerTimestamp = update.t;\n    gameStart = Date.now();\n  }\n  gameUpdates.push(update);\n  const base = getBaseUpdate();\n  if (base > 0) {\n    gameUpdates.splice(0, base);\n  }\n}\n\nfunction currentServerTime() {\n  return firstServerTimestamp + (Date.now() - gameStart) - RENDER_DELAY;\n}\n\n\nfunction getBaseUpdate() {\n  const serverTime = currentServerTime();\n  for (let i = gameUpdates.length - 1; i >= 0; i--) {\n    if (gameUpdates[i].t <= serverTime) {\n      return i;\n    }\n  }\n  return -1;\n}\n\n\nexport function getCurrentState() {\n  if (!firstServerTimestamp) {\n    return {};\n  }\n  const base = getBaseUpdate();\n  const serverTime = currentServerTime();\n  // If base is the most recent update we have, use its state.\n  // Otherwise, interpolate between its state and the state of (base + 1).\n  if (base < 0 || base === gameUpdates.length - 1) {\n    return gameUpdates[gameUpdates.length - 1];\n  } else {\n    const baseUpdate = gameUpdates[base];\n    const next = gameUpdates[base + 1];\n    const ratio = (serverTime - baseUpdate.t) / (next.t - baseUpdate.t);\n    return {\n      me: interpolateObject(baseUpdate.me, next.me, ratio),\n      others: baseUpdate.others,\n      lines: baseUpdate.lines,\n      remainders: baseUpdate.remainders,\n      usernames: baseUpdate.usernames\n    };\n  }\n}\n\nfunction interpolateObject(object1, object2, ratio) {\n  if (!object2) {\n    return object1;\n  }\n\n  const interpolated = {};\n  Object.keys(object1).forEach(key => {\n    if (key === 'coordinates') {\n      interpolated[key] = interpolateObjectArray(object1[key], object2[key], ratio)\n    }\n    else if (key === 'x' || key === 'y') {\n      interpolated[key] = object1[key] + (object2[key] - object1[key]) * ratio;\n    }\n    else if (key === 'color' || key === 'radius') {\n      interpolated[key] = object1[key];\n\n    }\n    else {\n      interpolated[key] = interpolateObject(object1[key], object2[key], ratio)\n    }\n  });\n  return interpolated;\n}\n\nfunction interpolateObjectArray(objects1, objects2, ratio) {\n\n  let arr = [];\n  for (let i = 0; i < objects1.length; i++) {\n    arr.push(interpolateObject(objects1[i], objects2[i], ratio))\n  }\n  return arr;\n}\n"],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}