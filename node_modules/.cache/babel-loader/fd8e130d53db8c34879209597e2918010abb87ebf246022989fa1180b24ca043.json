{"ast":null,"code":"const RENDER_DELAY=150;const gameUpdates=[];let gameStart=0;let firstServerTimestamp=0;export let ratio=0;export function initState(){gameStart=0;firstServerTimestamp=0;}export function processGameUpdate(update){if(!firstServerTimestamp){firstServerTimestamp=update.t;gameStart=Date.now();}gameUpdates.push(update);const base=getBaseUpdate();if(base>0){gameUpdates.splice(0,base);}}function currentServerTime(){return firstServerTimestamp+(Date.now()-gameStart)-RENDER_DELAY;}function getBaseUpdate(){const serverTime=currentServerTime();for(let i=gameUpdates.length-1;i>=0;i--){if(gameUpdates[i].t<=serverTime){return i;}}return-1;}export function getCurrentState(){if(!firstServerTimestamp){return{};}const base=getBaseUpdate();const serverTime=currentServerTime();// If base is the most recent update we have, use its state.\n// Otherwise, interpolate between its state and the state of (base + 1).\nif(base<0||base===gameUpdates.length-1){return gameUpdates[gameUpdates.length-1];}else{const baseUpdate=gameUpdates[base];const next=gameUpdates[base+1];ratio=(serverTime-baseUpdate.t)/(next.t-baseUpdate.t);return{me:interpolateObject(baseUpdate.me,next.me,ratio),others:interpolateObjectArray(baseUpdate.others,next.others,ratio),lines:baseUpdate.lines,remainders:baseUpdate.remainders,bots:baseUpdate.bots,usernames:baseUpdate.usernames};}}function interpolateObject(object1,object2,ratio){if(!object2){return object1;}const interpolated={};Object.keys(object1).forEach(key=>{if(key==='coordinates'){interpolated[key]=interpolateObjectArray(object1[key],object2[key],ratio);}else if(key==='x'||key==='y'){interpolated[key]=object1[key]+(object2[key]-object1[key])*ratio;}else if(key==='color'||key==='radius'||key==='username'){interpolated[key]=object1[key];}else{interpolated[key]=interpolateObject(object1[key],object2[key],ratio);}});return interpolated;}function interpolateObjectArray(objects1,objects2,ratio){let arr=[];for(let i=0;i<objects1.length;i++){arr.push(interpolateObject(objects1[i],objects2[i],ratio));}return arr;}","map":{"version":3,"names":["RENDER_DELAY","gameUpdates","gameStart","firstServerTimestamp","ratio","initState","processGameUpdate","update","t","Date","now","push","base","getBaseUpdate","splice","currentServerTime","serverTime","i","length","getCurrentState","baseUpdate","next","me","interpolateObject","others","interpolateObjectArray","lines","remainders","bots","usernames","object1","object2","interpolated","Object","keys","forEach","key","objects1","objects2","arr"],"sources":["/home/edi/secario.fun/frondend/src/services/state.js"],"sourcesContent":["const RENDER_DELAY = 150;\n\nconst gameUpdates = [];\nlet gameStart = 0;\nlet firstServerTimestamp = 0;\nexport let ratio = 0;\n\nexport function initState() {\n  gameStart = 0;\n  firstServerTimestamp = 0;\n}\n\nexport function processGameUpdate(update) {\n  if (!firstServerTimestamp) {\n    firstServerTimestamp = update.t;\n    gameStart = Date.now();\n  }\n  gameUpdates.push(update);\n  const base = getBaseUpdate();\n  if (base > 0) {\n    gameUpdates.splice(0, base);\n  }\n}\n\nfunction currentServerTime() {\n  return firstServerTimestamp + (Date.now() - gameStart) - RENDER_DELAY;\n}\n\n\nfunction getBaseUpdate() {\n  const serverTime = currentServerTime();\n  for (let i = gameUpdates.length - 1; i >= 0; i--) {\n    if (gameUpdates[i].t <= serverTime) {\n      return i;\n    }\n  }\n  return -1;\n}\n\n\nexport function getCurrentState() {\n  if (!firstServerTimestamp) {\n    return {};\n  }\n  const base = getBaseUpdate();\n  const serverTime = currentServerTime();\n  // If base is the most recent update we have, use its state.\n  // Otherwise, interpolate between its state and the state of (base + 1).\n  if (base < 0 || base === gameUpdates.length - 1) {\n    return gameUpdates[gameUpdates.length - 1];\n  } else {\n    const baseUpdate = gameUpdates[base];\n    const next = gameUpdates[base + 1];\n    ratio = (serverTime - baseUpdate.t) / (next.t - baseUpdate.t);\n    return {\n      me: interpolateObject(baseUpdate.me, next.me, ratio),\n      others: interpolateObjectArray(baseUpdate.others, next.others, ratio),\n      lines: baseUpdate.lines,\n      remainders: baseUpdate.remainders,\n      bots:baseUpdate.bots,\n      usernames: baseUpdate.usernames\n    };\n  }\n}\n\nfunction interpolateObject(object1, object2, ratio) {\n  if (!object2) {\n    return object1;\n  }\n\n  const interpolated = {};\n  Object.keys(object1).forEach(key => {\n    if (key === 'coordinates') {\n      interpolated[key] = interpolateObjectArray(object1[key], object2[key], ratio)\n    }\n    else if (key === 'x' || key === 'y') {\n      interpolated[key] = object1[key] + (object2[key] - object1[key]) * ratio;\n    }\n    else if (key === 'color' || key === 'radius' || key === 'username') {\n      interpolated[key] = object1[key];\n\n    }\n    else {\n      interpolated[key] = interpolateObject(object1[key], object2[key], ratio)\n    }\n  });\n  return interpolated;\n}\n\nfunction interpolateObjectArray(objects1, objects2, ratio) {\n\n  let arr = [];\n  for (let i = 0; i < objects1.length; i++) {\n    arr.push(interpolateObject(objects1[i], objects2[i], ratio))\n  }\n  return arr;\n}\n"],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}